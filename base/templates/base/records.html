{% extends 'main.html' %}
{% load static %}
{% load tz %}

{% block body_class %}records-page{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'styles/records.css' %}">
{% endblock %}

{% block content %}

<div class="container">
    
    <!-- Records 頁面標題區 -->
    <div class="records-header">
        <h1>Health Records Dashboard</h1>
        <p>View and manage all health monitoring records</p>
    </div>

    <!-- 篩選器區塊 -->
    <div class="filter-container">
        <div class="filter-content">
            <h3><img src="{% static 'images/Search.gif' %}" alt="Search" style="width: 40px; height: 40px;  vertical-align: middle;"> Filter Records</h3>
            <form method="get" class="modern-filter-form">
                <div class="filter-group">
                    <label>Person:</label>
                    <input type="text" name="person" value="{{ person_name }}" placeholder="Enter person name">
                </div>
                
                <div class="filter-group">
                    <label>Date:</label>
                    <input type="date" name="date" value="{{ date }}">
                </div>
                
                <div class="filter-actions">
                    <button type="submit" class="filter-btn primary">Filter</button>
                    <a class="filter-btn secondary" href="{% url 'records' %}">Reset</a>
                </div>
            </form>
        </div>
    </div>

    <!-- 記錄表格區塊 -->
    <div class="records-container">
        <div class="records-content">
            <div class="table-header">
                <h3>Health Records</h3>
                <div class="record-count">
                    Total: {{ records.paginator.count }} records
                </div>
            </div>
            
            <div class="table-wrapper">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Person</th>
                            <th>Dark Circles</th>
                            <th>Lip Type</th>
                            <th>Skin Condition</th>
                            <th>Health Status</th>
                            <th>Image</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in records %}
                        <tr class="record-row">
                            <td>{{ record.created.date }}</td>
                            <td>{{ record.created|localtime|time:"H:i" }}</td>
                            <td class="person-name">{{ record.person.person }}</td>
                            <td class="status-cell">
                                <span class="status-badge {% if record.dark_circles == 'none' %}success{% else %}danger{% endif %}">
                                    {{ record.dark_circles }}
                                </span>
                            </td>
                            <td class="status-cell">
                                <span class="status-badge {% if record.lip_type == 'normal' %}success{% else %}danger{% endif %}">
                                    {{ record.lip_type }}
                                </span>
                            </td>
                            <td class="status-cell">
                                <span class="status-badge {% if record.skin_condition == 'healthy' %}success{% else %}danger{% endif %}">
                                    {{ record.skin_condition }}
                                </span>
                            </td>
                            <td class="status-cell">
                                {% if record.dark_circles == 'none' and record.lip_type == 'normal' and record.skin_condition == 'healthy' %}
                                    <span class="status-badge success">Healthy</span>
                                {% else %}
                                    <span class="status-badge danger">Health Issues</span>
                                {% endif %}
                            </td>
                            <td class="image-cell">
                                {% if record.image %}
                                    <a href="javascript:void(0);" class="image-link" onclick="showImage('{{ record.image.image.url }}')">
                                        <img src="{% static 'images/Complete.png' %}" alt="Image" style="width: 30px; height: 30px; vertical-align: middle;">
                                        {{ record.image.name|slice:':10' }}...
                                    </a>
                                {% else %}
                                    <span class="no-image">No Image</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="no-data">
                                <div class="no-data-content">
                                    <span class="no-data-icon">📭</span>
                                    <p>No records found</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- 分頁控制 -->
            <div class="pagination-container">
                <div class="pagination-info">
                    <span>Page {{ records.number }} of {{ records.paginator.num_pages }}</span>
                </div>
                
                <div class="pagination-controls">
                    {% if records.has_previous %}
                        <a href="?page={{ records.previous_page_number }}{% if person_name %}&person={{ person_name }}{% endif %}{% if date %}&date={{ date }}{% endif %}" class="page-btn">Prev</a>
                    {% endif %}
                    
                    {% if records.has_next %}
                        <a href="?page={{ records.next_page_number }}{% if person_name %}&person={{ person_name }}{% endif %}{% if date %}&date={{ date }}{% endif %}" class="page-btn">Next</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 下載報告區塊 -->
    <div class="download-container">
        <div class="download-content">
            <h3>Download Report</h3>
            <p>Generate and download monthly health reports</p>
            <button class="download-btn" onclick="openModal()">
                <img src="{% static 'images/Download.gif' %}" alt="Download" style="width: 30px; height: 30px; vertical-align: middle; margin-right: 8px;">
                Download PDF Report
            </button>
        </div>
    </div>

</div>

<!-- 圖片查看模態框 -->
<div id="imageModal" class="image-modal">
    <span onclick="hideImage()" class="modal-close">&times;</span>
    <img id="modalImage" src="" class="modal-image">
</div>

<!-- 下載報告模態框 -->
<div id="monthModal" class="download-modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3>Select Month for Report</h3>
        <form id="downloadForm" method="GET" action="{% url 'download_report' %}">
            <div class="month-selector">
                <select name="month" required>
                    <option value="">-- Select Month --</option>
                    {% for index, month in months %}
                        <option value="{{ index }}">{{ month }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="modal-download-btn">
                <img src="{% static 'images/Download.gif' %}" alt="Download" style="width: 40px; height: 40px; vertical-align: middle; margin-right: 6px;">
                Download
            </button>
        </form>
    </div>
</div>

<script src="{% static 'js/func.js' %}"></script>

{% endblock content %}